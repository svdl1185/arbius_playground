{% extends 'base_no_nav.html' %}
{% load static %}

{% block title %}Arbius Playground - Chat{% endblock %}

{% block extra_css %}
<style>
  html, body {
    height: 100%; min-height: 100%; background: #0a0a0a; color: #fff; font-family: 'Inter', sans-serif;
    /* overflow: hidden; */
  }
  .navbar {
    width: 100%; background: #0a0a0a; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; height: 64px; min-height: 64px;
  }
  .navbar-logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.6rem; color: #fff; text-decoration: none; }
  .navbar-wallet { display: flex; align-items: center; gap: 10px; }
  .wallet-btn-outline { background: rgba(0,0,0,0.55) !important; color: white !important; border: 1.5px solid white !important; box-shadow: none !important; transition: background 0.2s, color 0.2s, border 0.2s; backdrop-filter: blur(2px); padding: 8px 18px; border-radius: 12px; font-weight: 600; font-size: 1.05rem; }
  .wallet-btn-outline:hover { background: rgba(0,0,0,0.75) !important; color: #fff !important; }
  .playground-root { display: flex; height: calc(100vh - 64px); min-height: 0; background: #0a0a0a; /* overflow: visible; */ }
  .sidebar { width: 260px; background: #181818; border-right: 1px solid #222; display: flex; flex-direction: column; transition: width 0.3s; min-width: 56px; position: relative; overflow: visible; }
  .sidebar.collapsed {
    width: 18px !important;
    min-width: 18px !important;
    overflow: visible !important;
    position: relative;
    background: #181818;
  }
  .sidebar-header { padding: 18px 18px 0 18px; display: flex; flex-direction: column; gap: 12px; }
  .sidebar .history-label { font-size: 0.8rem; color: #888; letter-spacing: 0.1em; margin: 18px 0 8px 18px; text-transform: uppercase; font-weight: 600; }
  .sidebar .filter-pills { display: flex; gap: 8px; margin: 0 0 10px 18px; }
  .filter-pill { background: #232323; color: #fff; border: none; border-radius: 999px; padding: 4px 12px; font-size: 0.95rem; cursor: pointer; transition: background 0.2s, color 0.2s; }
  .filter-pill.active, .filter-pill:hover { background: #fff; color: #181818; }
  .sidebar .history-list { flex: 1; overflow-y: auto; padding: 0 0 18px 0; margin: 0; }
  .history-item { display: flex; align-items: center; gap: 10px; padding: 9px 18px; font-size: 1rem; color: #ccc; cursor: pointer; border: none; background: none; width: 100%; transition: background 0.2s, color 0.2s; border-radius: 8px; }
  .history-item.selected, .history-item:hover { background: #232323; color: #fff; }
  .sidebar-toggle-btn {
    position: absolute;
    top: 50%;
    left: 100%;
    transform: translate(-50%, -50%);
    z-index: 60;
    background: #232323;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    transition: background 0.2s, left 0.3s;
  }
  .sidebar-toggle-btn:hover { background: #333; }
  .sidebar.collapsed .sidebar-header,
  .sidebar.collapsed .history-label,
  .sidebar.collapsed .filter-pills,
  .sidebar.collapsed .model-pills,
  .sidebar.collapsed .history-list {
    display: none !important;
  }
  .sidebar.collapsed {
    width: 18px !important;
    min-width: 18px !important;
    overflow: visible !important;
    position: relative;
    background: #181818;
  }
  .sidebar.collapsed .sidebar-toggle-btn {
    left: 100%;
    transform: translate(-50%, -50%);
  }
  .sidebar.collapsed .history-item { justify-content: center; padding-left: 0; padding-right: 0; }
  .sidebar.collapsed .history-item span { display: none; }
  .sidebar.collapsed .history-item i { margin: 0; }
  .main-area { flex: 1; display: flex; flex-direction: column; height: 100%; min-width: 0; background: #0a0a0a; }
  .main-header { display: flex; align-items: center; justify-content: space-between; padding: 28px 36px 12px 36px; border-bottom: 1px solid #222; }
  .main-header .model-indicator { font-size: 0.95rem; color: #aaa; margin-top: 2px; }
  .chat-area { flex: 1; overflow-y: auto; padding: 28px 0 0 0; display: flex; flex-direction: column; align-items: stretch; min-height: 0; }
  .chat-message-row { display: flex; align-items: flex-end; gap: 12px; margin: 0 0 18px 0; padding: 0 36px; position: relative; }
  .chat-message-row.user { flex-direction: row-reverse; justify-content: flex-end; }
  .chat-message-row.assistant { flex-direction: row; justify-content: flex-start; }
  .chat-message-avatar { width: 32px; height: 32px; border-radius: 50%; background: #fff; color: #181818; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; }
  .chat-message-content { background: #232a3a; color: #fff; border-radius: 14px; padding: 10px 16px; font-size: 1.02rem; max-width: 520px; word-break: break-word; }
  .chat-message-row.user .chat-message-avatar { background: #fff; color: #181818; }
  .chat-message-row.assistant .chat-message-avatar { background: #3b82f6; color: #fff; }
  .chat-message-row.user .chat-message-content { background: #232323; color: #fff; }
  .chat-message-row.assistant .chat-message-content { background: #232a3a; color: #fff; }
  .chat-message-actions { display: flex; align-items: center; gap: 8px; margin-top: 2px; }
  .chat-message-actions button { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.1rem; padding: 2px 6px; border-radius: 6px; transition: background 0.2s, color 0.2s; }
  .chat-message-actions button:hover { background: #232323; color: #fff; }
  .chat-input-bar { width: 100%; padding: 0 0 18px 0; background: none; border: none; display: flex; align-items: center; justify-content: center; }
  .chat-input-inner { display: flex; align-items: center; width: 100%; max-width: 600px; background: #181818; border-radius: 999px; border: 1.5px solid #fff; padding: 8px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); }
  .chat-input-inner textarea { flex: 1; background: transparent; border: none; color: #fff; font-size: 1.05rem; padding: 8px 0; resize: none; outline: none; min-height: 32px; max-height: 100px; }
  .chat-input-inner button { background: #fff; color: #181818; border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-left: 8px; cursor: pointer; transition: background 0.2s, color 0.2s; }
  .chat-input-inner button:hover { background: #e5e5e5; color: #181818; }
  .model-select-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,10,0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .model-select-title { font-size: 2rem; font-weight: 600; margin-bottom: 32px; color: #fff; }
  .model-select-pills { display: flex; gap: 18px; margin-bottom: 18px; }
  .model-select-pill { display: flex; align-items: center; gap: 8px; padding: 14px 28px; border-radius: 999px; background: #232323; color: #fff; font-size: 1.1rem; font-weight: 500; border: none; cursor: pointer; transition: background 0.2s, color 0.2s; }
  .model-select-pill.selected, .model-select-pill:hover { background: #fff; color: #181818; }
  .model-select-pill.disabled { opacity: 0.5; cursor: not-allowed; }
  @media (max-width: 900px) { .sidebar { width: 56px !important; min-width: 56px !important; } .sidebar:not(.collapsed) { width: 220px !important; } .main-header, .chat-message-row { padding-left: 16px; padding-right: 16px; } }
  @media (max-width: 600px) { .main-header, .chat-message-row { padding-left: 4px; padding-right: 4px; } .chat-input-inner { max-width: 98vw; } }
#chat-selected-model-short {
  margin-right: 2px !important;
}
.chat-input-inner button {
  margin-left: 2px !important;
}
.chat-input-inner {
  padding-left: 6px !important;
  padding-right: 6px !important;
}
</style>
{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar">
  <a href="/" class="navbar-logo">
        <img src="{% static 'arbius.ef337b97.svg' %}" alt="Arbius Logo" class="inline-block w-7 h-7" />
        Arbius
      </a>
  <div class="navbar-wallet">
    <button class="wallet-btn-outline"><i class="fas fa-wallet"></i> Connect Wallet</button>
  </div>
</nav>
<div class="playground-root">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <button class="sidebar-toggle-btn" id="sidebar-toggle-btn"><i class="fas fa-angle-left"></i></button>
    <div class="sidebar-header">
      <button id="new-chat-btn" style="background:#fff;color:#181818;font-weight:600;border:none;border-radius:999px;padding:10px 0;margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1.05rem;cursor:pointer;width:100%;"><i class="fas fa-plus"></i> <span style="font-size:1rem;">New Chat</span></button>
    </div>
    <div class="history-label">History</div>
    <div class="filter-pills">
      <button class="filter-pill active" data-type="all">All</button>
      <button class="filter-pill" data-type="text"><i class="fas fa-comment-dots"></i></button>
      <button class="filter-pill" data-type="image"><i class="fas fa-image"></i></button>
      <button class="filter-pill" data-type="video"><i class="fas fa-video"></i></button>
      </div>
    <div class="history-list" id="history-list">
      <div class="history-item" data-id="test" data-type="text"><i class="fas fa-comment-dots"></i> <span>Test Conversation</span></div>
      <div class="history-item" data-id="basilisk" data-type="text"><i class="fas fa-comment-dots"></i> <span>What is Roko's Basilisk?</span></div>
      <div class="history-item" data-id="malinois" data-type="text"><i class="fas fa-comment-dots"></i> <span>How to train a Belgian Malinois</span></div>
      <div class="history-item" data-id="elon" data-type="image"><i class="fas fa-image"></i> <span>Elon Musk naked with...</span></div>
      <div class="history-item" data-id="koala" data-type="text"><i class="fas fa-comment-dots"></i> <span>Koala</span></div>
      <div class="history-item" data-id="film" data-type="video"><i class="fas fa-video"></i> <span>AI-generated short film</span></div>
      </div>
  </aside>
  <!-- Main Area -->
  <main class="main-area" style="position: relative;">
    <div class="chat-area" id="chat-area" style="position:relative;">
      <!-- Model Selection Centered (inline, not overlay) -->
      <div id="model-select-center" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;top:0;left:0;pointer-events:auto;">
        <div style="font-size:1.1rem;font-weight:500;color:#fff;margin-bottom:20px;">Select Model</div>
        <div style="display:flex;gap:16px;">
          <button class="model-bubble" data-model="m8b-uncensored" style="background:transparent;color:#fff;border:1.5px solid #444;border-radius:999px;padding:10px 20px;font-size:0.98rem;font-weight:500;display:flex;align-items:center;gap:8px;transition:background 0.2s,border 0.2s;cursor:pointer;outline:none;">
            <i class="fas fa-comment-dots" style="font-size:1.05rem;"></i> M8B-Uncensored
          </button>
          <button class="model-bubble" data-model="wai" style="background:transparent;color:#fff;border:1.5px solid #444;border-radius:999px;padding:10px 20px;font-size:0.98rem;font-weight:500;display:flex;align-items:center;gap:8px;transition:background 0.2s,border 0.2s;cursor:pointer;outline:none;">
            <i class="fas fa-image" style="font-size:1.05rem;"></i> WAI SDXL (NSFW)
          </button>
          <button class="model-bubble" data-model="qwen-qwq" style="background:transparent;color:#fff;border:1.5px solid #444;border-radius:999px;padding:10px 20px;font-size:0.98rem;font-weight:500;display:flex;align-items:center;gap:8px;transition:background 0.2s,border 0.2s;cursor:pointer;outline:none;">
            <i class="fas fa-comment-dots" style="font-size:1.05rem;"></i> Qwen QwQ 32b
          </button>
        </div>
      </div>
      <!-- Test Conversation -->
      <div id="test-conversation" class="chat-conversation" style="display:none;">
        <div class="chat-message-row user">
          <div class="chat-message-avatar">U</div>
          <div class="chat-message-content">Hello, what can you do?</div>
          <div class="chat-message-actions"><button class="copy-btn" title="Copy"><i class="fas fa-copy"></i></button></div>
              </div>
        <div class="chat-message-row assistant">
          <div class="chat-message-avatar">A</div>
          <div class="chat-message-content">Hi! I can answer questions, generate images, and more. Try asking me anything!</div>
          <div class="chat-message-actions"><button class="copy-btn" title="Copy"><i class="fas fa-copy"></i></button></div>
            </div>
        <div class="chat-message-row user">
          <div class="chat-message-avatar">U</div>
          <div class="chat-message-content">Draw a cat surfing a wave.</div>
          <div class="chat-message-actions"><button class="copy-btn" title="Copy"><i class="fas fa-copy"></i></button></div>
        </div>
        <div class="chat-message-row assistant">
          <div class="chat-message-avatar">A</div>
          <div class="chat-message-content">Here's an image of a cat surfing a wave! üèÑ‚Äç‚¨õüåä</div>
          <div class="chat-message-actions"><button class="copy-btn" title="Copy"><i class="fas fa-copy"></i></button></div>
        </div>
      </div>
      <!-- Add more conversations here as needed -->
    </div>
    <form class="chat-input-bar" autocomplete="off" style="padding-bottom:10px;">
      <div class="chat-input-inner" style="max-width:800px;min-height:36px;padding:4px 12px;">
        <div id="chat-selected-model-short" style="background:#232323;color:#fff;border-radius:999px;padding:4px 14px;font-size:1rem;font-weight:600;display:none;align-items:center;gap:7px;margin-right:10px;">
          <span id="current-model-icon" style="font-size:1.1rem;display:flex;align-items:center;"></span>
          <span id="current-model-pill"></span>
        </div>
        <textarea placeholder="Type your message..." rows="1" style="min-height:28px;font-size:1rem;"></textarea>
        <button type="submit"><i class="fas fa-paper-plane"></i></button>
      </div>
    </form>
    <!-- Model Selection Overlay (hidden by default, show with JS) -->
    <div id="model-select-overlay" class="model-select-overlay" style="display: none;">
      <div class="model-select-title">Choose your preferred model</div>
      <div class="model-select-pills">
        <button class="model-select-pill" data-model="m8b-uncensored">üìù M8B-Uncensored</button>
        <button class="model-select-pill" data-model="qwen-qwq-32b">üìù Qwen QwQ 32b</button>
        <button class="model-select-pill" data-model="wai-sdxl">üñºÔ∏è WAI SDXL (NSFW)</button>
        <button class="model-select-pill disabled" disabled>‚è≥ More coming soon...</button>
</div>
    </div>
  </main>
</div>
<script>
// Sidebar collapse logic
const sidebar = document.getElementById('sidebar');
const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
sidebarToggleBtn.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  sidebarToggleBtn.querySelector('i').classList.toggle('fa-angle-left');
  sidebarToggleBtn.querySelector('i').classList.toggle('fa-angle-right');
});
// History filter logic
const filterPills = document.querySelectorAll('.filter-pill');
const historyItems = document.querySelectorAll('.history-item');
filterPills.forEach(pill => {
  pill.addEventListener('click', () => {
    filterPills.forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    const type = pill.getAttribute('data-type');
    historyItems.forEach(item => {
      if (type === 'all' || item.getAttribute('data-type') === type) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  });
});
// --- REIMPLEMENTED LOGIC ---
const chatArea = document.getElementById('chat-area');
const modelSelectCenter = document.getElementById('model-select-center');
const modelBubbles = document.querySelectorAll('.model-bubble');
const modelPill = document.getElementById('chat-selected-model-short');
const modelPillLabel = document.getElementById('current-model-pill');
const modelPillIcon = document.getElementById('current-model-icon');
const newChatBtn = document.getElementById('new-chat-btn');
let currentModel = null;
let currentConversationId = null;

function showModelSelect() {
  modelSelectCenter.style.display = 'flex';
  if (modelPill) modelPill.style.display = 'none';
  // Hide all conversations
  chatArea.querySelectorAll('.chat-conversation').forEach(e => e.style.display = 'none');
  // Deselect all history items
  document.querySelectorAll('.history-item').forEach(item => item.classList.remove('selected'));
}
function hideModelSelect() {
  modelSelectCenter.style.display = 'none';
}
function showConversation(convoId) {
  // Hide model select
  hideModelSelect();
  // Hide all conversations
  chatArea.querySelectorAll('.chat-conversation').forEach(e => e.style.display = 'none');
  // Show the selected conversation
  const convo = document.getElementById(convoId);
  if (convo) convo.style.display = '';
}
function showModelPill(model) {
  const MODEL_MAP = {
    'm8b-uncensored': { label: 'M8B', icon: '<i class="fas fa-comment-dots"></i>' },
    'wai': { label: 'WAI', icon: '<i class="fas fa-image"></i>' },
    'qwen-qwq': { label: 'Qwen', icon: '<i class="fas fa-comment-dots"></i>' },
    'deepseek': { label: 'Deepseek', icon: '<i class="fas fa-code"></i>' }
  };
  if (model && MODEL_MAP[model]) {
    modelPill.style.display = 'flex';
    modelPillLabel.textContent = MODEL_MAP[model].label;
    modelPillIcon.innerHTML = MODEL_MAP[model].icon;
  } else {
    modelPill.style.display = 'none';
    modelPillLabel.textContent = '';
    modelPillIcon.innerHTML = '';
  }
}
function clearModelSelection() {
  currentModel = null;
  showModelSelect();
  showModelPill(null);
}
// On page load, always show model selection
window.addEventListener('DOMContentLoaded', () => {
  clearModelSelection();
});
// Model selection bubbles
modelBubbles.forEach(btn => {
  btn.addEventListener('click', () => {
    currentModel = btn.getAttribute('data-model');
    hideModelSelect();
    showModelPill(currentModel);
    // Show a new/empty conversation area (or keep it empty)
    // Optionally, you can create a new conversation div dynamically here
  });
});
// New Chat button
if (newChatBtn) {
  newChatBtn.addEventListener('click', () => {
    clearModelSelection();
  });
}
// History item click
historyItems.forEach(item => {
  item.addEventListener('click', () => {
    // Deselect all
    historyItems.forEach(i => i.classList.remove('selected'));
    item.classList.add('selected');
    // Show the conversation
    const convoId = item.getAttribute('data-id') + '-conversation';
    showConversation(convoId);
    // For demo: set model to M8B for test, Qwen for basilisk, WAI for elon, etc.
    let model = null;
    if (item.getAttribute('data-id') === 'test') model = 'm8b-uncensored';
    else if (item.getAttribute('data-id') === 'basilisk') model = 'qwen-qwq';
    else if (item.getAttribute('data-id') === 'elon') model = 'wai';
    else model = 'm8b-uncensored'; // fallback
    showModelPill(model);
    hideModelSelect();
  });
});
// Copy button logic
const copyBtns = document.querySelectorAll('.copy-btn');
copyBtns.forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const content = btn.parentElement.previousElementSibling.textContent;
    navigator.clipboard.writeText(content);
    btn.classList.add('copied');
    setTimeout(() => btn.classList.remove('copied'), 800);
  });
});
// Model indicator update
function updateModelPill() {
  let model = null;
  if (window.getSelectedModel) {
    const stored = window.getSelectedModel();
    // Only treat as selected if not null/undefined/empty string
    if (stored && stored !== 'null' && stored !== 'undefined' && stored !== '') {
      model = stored;
    }
  }
  const pill = document.getElementById('chat-selected-model-short');
  const pillLabel = document.getElementById('current-model-pill');
  const pillIcon = document.getElementById('current-model-icon');
  if (!pill || !pillLabel || !pillIcon) return;
  const MODEL_MAP = {
    'm8b-uncensored': { label: 'M8B', icon: '<i class="fas fa-comment-dots"></i>' },
    'wai': { label: 'WAI', icon: '<i class="fas fa-image"></i>' },
    'qwen-qwq': { label: 'Qwen', icon: '<i class="fas fa-comment-dots"></i>' },
    'deepseek': { label: 'Deepseek', icon: '<i class="fas fa-code"></i>' }
  };
  if (model && MODEL_MAP[model]) {
    pill.style.display = 'flex';
    pillLabel.textContent = MODEL_MAP[model].label;
    pillIcon.innerHTML = MODEL_MAP[model].icon;
  } else {
    pill.style.display = 'none';
    pillLabel.textContent = '';
    pillIcon.innerHTML = '';
  }
}
document.addEventListener('DOMContentLoaded', updateModelPill);
if (window.setSelectedModel) {
  const orig = window.setSelectedModel;
  window.setSelectedModel = function(model) {
    orig(model);
    updateModelPill();
  };
}
// Model selection center logic (inline, not overlay)
function isChatEmpty() {
  // Check if there are any visible chat messages
  return !chatArea.querySelector('.chat-message-row');
}
// Hide model select if a message is sent (optional: you can also call this after sending a message)
</script>
{% endblock %} 