{% extends 'base.html' %}
{% load static %}

{% block title %}Arbius Playground - Chat{% endblock %}

{% block extra_css %}
<style>
  /* Base responsive styles */
  * {
    box-sizing: border-box;
  }
  
  img {
    max-width: 100%;
    height: auto;
  }
  
  html, body {
    height: 100vh !important;
    min-height: 100vh !important;
    overflow: hidden !important;
    background: #0a0a0a;
    color: #fff;
    font-family: 'Inter', sans-serif;
  }
  .playground-root {
    display: flex;
    flex-direction: row;
    height: calc(100vh - 64px) !important;
    min-height: 0 !important;
    background: #0a0a0a;
    width: 100%;
    overflow: hidden !important;
    margin-top: 0;
  }
  .sidebar { 
    width: 260px; 
    background: #181818; 
    border-right: 1px solid #222; 
    display: flex; 
    flex-direction: column; 
    transition: width 0.3s; 
    min-width: 56px; 
    position: relative; 
    overflow: visible; 
  }
  .sidebar.collapsed {
    width: 18px !important;
    min-width: 18px !important;
    overflow: visible !important;
    position: relative;
    background: #181818;
  }
  .sidebar-header { padding: 18px 18px 0 18px; display: flex; flex-direction: column; gap: 12px; }
  .sidebar .history-label { font-size: 0.8rem; color: #888; letter-spacing: 0.1em; margin: 18px 0 8px 18px; text-transform: uppercase; font-weight: 600; }
  .sidebar .filter-pills { display: flex; gap: 8px; margin: 0 0 10px 18px; }
  .filter-pill { background: #232323; color: #fff; border: none; border-radius: 999px; padding: 4px 12px; font-size: 0.95rem; cursor: pointer; transition: background 0.2s, color 0.2s; }
  .filter-pill.active, .filter-pill:hover { background: #fff; color: #181818; }
  .sidebar .history-list { flex: 1; overflow-y: auto; padding: 0 0 18px 0; margin: 0; }
  .history-item { display: flex; align-items: center; gap: 10px; padding: 9px 18px; font-size: 1rem; color: #ccc; cursor: pointer; border: none; background: none; width: 100%; transition: background 0.2s, color 0.2s; border-radius: 8px; }
  .history-item.selected, .history-item:hover { background: #232323; color: #fff; }
  .sidebar-toggle-btn {
    position: absolute;
    top: 50%;
    left: 100%;
    transform: translate(-50%, -50%);
    z-index: 60;
    background: #232323;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    transition: background 0.2s, left 0.3s;
  }
  .sidebar-toggle-btn:hover { background: #333; }
  .sidebar.collapsed .sidebar-header,
  .sidebar.collapsed .history-label,
  .sidebar.collapsed .filter-pills,
  .sidebar.collapsed .model-pills,
  .sidebar.collapsed .history-list {
    display: none !important;
  }
  .sidebar.collapsed {
    width: 18px !important;
    min-width: 18px !important;
    overflow: visible !important;
    position: relative;
    background: #181818;
  }
  .sidebar.collapsed .sidebar-toggle-btn {
    left: 100%;
    transform: translate(-50%, -50%);
  }
  .sidebar.collapsed .history-item { justify-content: center; padding-left: 0; padding-right: 0; }
  .sidebar.collapsed .history-item span { display: none; }
  .sidebar.collapsed .history-item i { margin: 0; }
  .main-area { flex: 1; display: flex; flex-direction: column; height: 100%; min-width: 0; background: #0a0a0a; width: 100%; }
  .main-header { display: flex; align-items: center; justify-content: space-between; padding: 28px 36px 12px 36px; border-bottom: 1px solid #222; }
  .main-header .model-indicator { font-size: 0.95rem; color: #aaa; margin-top: 2px; }
  .chat-area {
    flex: 1;
    width: 100%;
    min-height: 0;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 28px 0 0 0;
    background: #0a0a0a;
    position: relative;
  }
  .chat-messages-inner {
    max-width: 1100px;
    margin: 0 auto;
    width: 100%;
    overflow-y: auto;
  }
  .sidebar-collapsed .chat-messages-inner,
  .sidebar-collapsed .chat-input-inner {
    max-width: 1400px;
  }
  .chat-message-row {
    display: flex;
    align-items: flex-end;
    width: 100%;
    margin-bottom: 24px;
    padding-left: 0;
    padding-right: 0;
  }
  .chat-message-row.user {
    justify-content: flex-end;
  }
  .chat-message-row.assistant {
    justify-content: flex-start;
    flex-direction: row;
  }
  .chat-message-row.assistant .chat-message-avatar {
    margin-left: 0;
    margin-right: 8px;
    order: 0;
  }
  .chat-message-row.assistant .chat-message-content {
    margin-left: 0;
    margin-right: 0;
    order: 1;
  }
  .chat-message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #181818;
    border: 2px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1rem;
    margin: 0 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    padding: 0;
  }
  .chat-message-row.user .chat-message-avatar {
    display: none;
  }
  .chat-message-row.assistant .chat-message-avatar {
    background: #3b82f6;
    color: #fff;
    order: 1;
  }
  .chat-message-content {
    font-size: 0.82rem;
    line-height: 1.35;
    word-break: break-word;
    display: inline-block;
  }
  .chat-message-row.user .chat-message-content {
    background: #232323;
    color: #fff;
    border-radius: 14px;
    padding: 10px 16px;
    margin-right: 8px;
    margin-left: 15%;
    max-width: 80%;
  }
  .chat-message-row.assistant .chat-message-content {
    background: none;
    color: #fff;
    border-radius: 0;
    padding: 0;
    margin-left: 8px;
    margin-right: 15%;
    max-width: 80%;
  }
  .chat-message-actions { display: flex; align-items: center; gap: 8px; margin-top: 2px; }
  .chat-message-actions button { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.1rem; padding: 2px 6px; border-radius: 6px; transition: background 0.2s, color 0.2s; }
  .chat-message-actions button:hover { background: #232323; color: #fff; }
  .chat-input-bar { width: 100%; padding: 0 0 18px 0; background: none; border: none; display: flex; align-items: center; justify-content: center; }
  .chat-input-inner {
    display: flex;
    align-items: center;
    width: 100%;
    background: #181818;
    border-radius: 999px;
    border: 1.5px solid #fff;
    padding: 8px 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  }
  /* Wider input when sidebar is collapsed */
  .sidebar.collapsed ~ .main-area .chat-input-inner {
    max-width: 1400px;
  }
  .chat-input-inner textarea {
    flex: 1;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 0.82rem;
    line-height: 1.35;
    padding: 5px 10px;
    resize: none;
    outline: none;
    min-height: 32px;
    max-height: 200px;
    overflow-y: auto;
  }
  .chat-input-inner button { background: #fff; color: #181818; border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-left: 8px; cursor: pointer; transition: background 0.2s, color 0.2s; }
  .chat-input-inner button:hover { background: #e5e5e5; color: #181818; }
  .model-select-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,10,0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .model-select-title { font-size: 2rem; font-weight: 600; margin-bottom: 32px; color: #fff; }
  .model-select-pills { display: flex; gap: 18px; margin-bottom: 18px; }
  .model-select-pill { display: flex; align-items: center; gap: 8px; padding: 14px 28px; border-radius: 999px; background: #232323; color: #fff; font-size: 1.1rem; font-weight: 500; border: none; cursor: pointer; transition: background 0.2s, color 0.2s; }
  .model-select-pill.selected, .model-select-pill:hover { background: #fff; color: #181818; }
  .model-select-pill.disabled { opacity: 0.5; cursor: not-allowed; }
  /* Mobile responsive styles */
  @media (max-width: 900px) { 
    .sidebar { 
      width: 56px !important; 
      min-width: 56px !important; 
    } 
    .sidebar:not(.collapsed) { 
      width: 220px !important; 
    } 
    .main-header, .chat-message-row { 
      padding-left: 16px; 
      padding-right: 16px; 
    } 
  }
  
  @media (max-width: 768px) {
    /* Improve touch targets */
    button, a, [role="button"] {
      min-height: 44px;
      min-width: 44px;
    }
    
    /* Adjust sidebar for mobile */
    .sidebar {
      width: 100% !important;
      min-width: 100% !important;
      position: fixed;
      top: 64px;
      left: -100%;
      height: calc(100vh - 64px);
      z-index: 50;
      transition: left 0.3s ease;
    }
    
    .sidebar.open {
      left: 0;
    }
    
    .sidebar.collapsed {
      width: 100% !important;
      min-width: 100% !important;
    }
    
    /* Adjust main area for mobile */
    .main-area {
      width: 100%;
      margin-left: 0;
    }
    
    /* Improve chat input for mobile */
    .chat-input-inner {
      max-width: 95vw !important;
      margin: 0 1rem;
      padding: 0.75rem 1rem;
    }
    
    .chat-input-inner textarea {
      font-size: 1rem;
      min-height: 44px;
    }
    
    .chat-input-inner button {
      width: 44px;
      height: 44px;
      font-size: 1.2rem;
    }
    
    /* Adjust model selection for mobile */
    #model-select-center {
      padding: 0 1rem;
    }
    
    #model-select-center > div:last-child {
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }
    
    .model-bubble {
      width: 100%;
      justify-content: center;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      min-height: 48px;
    }
    
    /* Improve chat messages for mobile */
    .chat-message-row {
      padding-left: 1rem;
      padding-right: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .chat-message-content {
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .chat-message-row.user .chat-message-content {
      margin-left: 7%;
      max-width: 90%;
    }
    
    .chat-message-row.assistant .chat-message-content {
      margin-right: 7%;
      max-width: 90%;
    }
    
    /* Improve sidebar toggle button */
    .sidebar-toggle-btn {
      position: fixed;
      top: 80px;
      left: 1rem;
      z-index: 60;
      width: 44px;
      height: 44px;
      background: #232323;
      border-radius: 50%;
    }
    
    /* Adjust history items for mobile */
    .history-item {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      min-height: 44px;
    }
    
    /* Improve filter pills for mobile */
    .filter-pill {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      min-height: 44px;
    }
  }
  
  @media (max-width: 600px) { 
    .main-header, .chat-message-row { 
      padding-left: 0.75rem; 
      padding-right: 0.75rem; 
    } 
    .chat-input-inner { 
      max-width: 92vw !important; 
      margin: 0 0.75rem;
    }
    
    .chat-message-row {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    
    .chat-message-row.user .chat-message-content {
      margin-left: 7%;
      max-width: 90%;
    }
    
    .chat-message-row.assistant .chat-message-content {
      margin-right: 7%;
      max-width: 90%;
    }
    
    .model-bubble {
      padding: 0.875rem 1.25rem;
      font-size: 0.9rem;
    }
  }
  
  @media (max-width: 480px) {
    .chat-input-inner {
      max-width: 90vw !important;
      margin: 0 0.5rem;
      padding: 0.625rem 0.875rem;
    }
    
    .chat-message-row {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    
    .chat-message-row.user .chat-message-content {
      margin-left: 3%;
      max-width: 94%;
    }
    
    .chat-message-row.assistant .chat-message-content {
      margin-right: 3%;
      max-width: 94%;
    }
    
    .model-bubble {
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
    }
    
    .sidebar-toggle-btn {
      left: 0.5rem;
    }
  }
  
  /* Touch device optimizations */
  @media (hover: none) and (pointer: coarse) {
    /* Increase spacing for touch interactions */
    .history-item {
      margin: 0.25rem 0;
    }
    
    .filter-pill {
      margin: 0.25rem 0;
    }
    
    .model-bubble {
      margin: 0.25rem 0;
    }
  }
#chat-selected-model-short {
  margin-right: 2px !important;
}
.chat-input-inner button {
  margin-left: 2px !important;
}
.chat-input-inner {
  padding-left: 6px !important;
  padding-right: 6px !important;
}
.chat-main-inner {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;
  max-width: 900px;
  margin: 0 auto;
  width: 100%;
  align-items: stretch;
  position: relative;
  padding-bottom: 0; /* remove extra space for fixed input bar */
}
.sidebar-collapsed .chat-main-inner {
  max-width: 1200px;
}
.chat-messages-inner {
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  max-width: 1100px;
  margin: 0 auto;
  width: 100%;
}
.chat-input-bar {
  position: sticky;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  background: none;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  box-shadow: none !important;
  padding: 0 0 18px 0;
  margin-left: 0;
  transition: none;
}
.sidebar.collapsed ~ .main-area .chat-input-bar,
.sidebar-collapsed .chat-input-bar {
  margin-left: 18px;
}
.chat-input-inner {
  display: flex;
  align-items: center;
  width: 100%;
  background: #181818;
  border-radius: 999px;
  border: 1.5px solid #fff;
  padding: 8px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  max-width: 900px;
  margin: 0 auto;
}
.sidebar-collapsed .chat-input-inner {
  max-width: 1200px;
}
/* Center model selection UI */
#model-select-center {
  max-width: 1100px;
  margin: 0 auto;
  left: 0;
  right: 0;
}
.sidebar-collapsed #model-select-center {
  max-width: 1400px;
}
  .history-item {
    font-size: 0.85rem;
    line-height: 1.3;
    padding: 7px 14px;
  }
  .sidebar .history-label {
    font-size: 0.75rem;
  }
  .sidebar .filter-pills, .sidebar .history-list {
    font-size: 0.85rem;
  }
  .wallet-btn-outline, .navbar-wallet .wallet-btn-outline, #connect-wallet-btn, #connect-wallet-btn-mobile {
    background: #fff !important;
    color: #181828 !important;
    border: none !important;
    box-shadow: none !important;
    border-radius: 999px !important;
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    padding: 6px 22px !important;
    min-width: 0 !important;
    min-height: 0 !important;
    height: auto !important;
    display: inline-flex;
    align-items: center !important;
    justify-content: center !important;
    gap: 0 !important;
  }
  .navbar-wallet {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .wallet-connected-dropdown {
    display: inline-block;
    position: relative;
    vertical-align: middle;
  }
  .wallet-address-pill {
    background: transparent;
    color: #fff;
    border: 2px solid #fff;
    border-radius: 999px;
    font-size: 0.95rem;
    font-weight: 500;
    padding: 6px 22px;
    min-width: 0;
    min-height: 0;
    height: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 6px;
    transition: border 0.2s, background 0.2s;
  }
  .wallet-address-pill:hover, .wallet-address-pill:focus {
    background: rgba(255,255,255,0.08);
    border-color: #fff;
  }
  .wallet-dropdown-menu {
    position: absolute;
    top: 110%;
    left: 0;
    background: #232a3a;
    border-radius: 18px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 22px 0 18px 0;
    min-width: 210px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .wallet-dropdown-item {
    color: #fff;
    text-decoration: none;
    font-size: 1.08rem;
    padding: 12px 28px 12px 22px;
    display: flex;
    align-items: center;
    gap: 16px;
    border: none;
    background: none;
    cursor: pointer;
    transition: background 0.15s;
    border-radius: 12px;
  }
  .wallet-dropdown-item:hover {
    background: #2e3542;
  }
  @media (max-width: 768px) {
    .playground-root {
      flex-direction: column;
      height: calc(100dvh - 64px) !important;
      min-height: 0 !important;
      overflow: visible !important;
    }
    .sidebar {
      position: fixed;
      top: 64px;
      left: -100%;
      width: 80vw !important;
      max-width: 320px;
      min-width: 0 !important;
      height: calc(100dvh - 64px);
      z-index: 50;
      transition: left 0.3s ease;
      box-shadow: 2px 0 16px rgba(0,0,0,0.25);
    }
    .sidebar.open {
      left: 0;
    }
    .main-area {
      flex: 1 1 auto;
      min-height: 0;
      width: 100vw;
      height: calc(100dvh - 64px);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    .chat-main-inner {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 100vw;
      margin: 0;
      padding-bottom: 0;
    }
    .chat-area {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding-bottom: 70px;
    }
    .chat-input-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100;
      background: transparent !important;
      box-shadow: none !important;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    .chat-input-inner {
      max-width: 100vw !important;
      margin: 0 auto;
      padding: 0.75rem 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="playground-root" style="margin-top: 0px;">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <button class="sidebar-toggle-btn" id="sidebar-toggle-btn">
      <i class="fas fa-bars icon-mobile" style="display:none;"></i>
      <i class="fas fa-angle-left icon-desktop" style="display:none;"></i>
      <i class="fas fa-angle-right icon-desktop" style="display:none;"></i>
    </button>
    <div class="sidebar-header">
      <button id="new-chat-btn" style="background:#fff;color:#181818;font-weight:600;border:none;border-radius:999px;padding:10px 0;margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1.05rem;cursor:pointer;width:100%;"><i class="fas fa-plus"></i> <span style="font-size:1rem;">New Chat</span></button>
    </div>
    <div class="history-label">History</div>
    <div class="filter-pills">
      <button class="filter-pill active" data-type="all">All</button>
      <button class="filter-pill" data-type="text"><i class="fas fa-comment-dots"></i></button>
      <button class="filter-pill" data-type="image"><i class="fas fa-image"></i></button>
      <button class="filter-pill" data-type="video"><i class="fas fa-video"></i></button>
      </div>
    <div class="history-list" id="history-list">
      <div class="history-item" data-id="longexchange" data-type="text"><i class="fas fa-comment-dots"></i> <span>Long Exchange</span></div>
      <div class="history-item" data-id="longtext" data-type="text"><i class="fas fa-comment-dots"></i> <span>Long Prompt/Answer</span></div>
      <div class="history-item" data-id="coding" data-type="text"><i class="fas fa-comment-dots"></i> <span>Python Coding Q&A</span></div>
      <div class="history-item" data-id="elon" data-type="image"><i class="fas fa-image"></i> <span>Elon Musk naked with...</span></div>
      <div class="history-item" data-id="film" data-type="video"><i class="fas fa-video"></i> <span>AI-generated short film</span></div>
    </div>
  </aside>
  <!-- Main Area -->
  <main class="main-area" style="position: relative;">
    <div class="chat-main-inner">
      <div class="chat-area" id="chat-area" style="position:relative;">
        <div class="chat-messages-inner">
          <!-- Model Selection Centered (inline, not overlay) -->
          <div id="model-select-center" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;top:0;left:0;pointer-events:auto;">
            <div style="font-size:1.1rem;font-weight:500;color:#fff;margin-bottom:20px;">Select Model</div>
            <div style="display:flex;gap:16px;">
              <button class="model-bubble" data-model="m8b-uncensored" style="background:transparent;color:#fff;border:1.5px solid #444;border-radius:999px;padding:10px 20px;font-size:0.98rem;font-weight:500;display:flex;align-items:center;gap:8px;transition:background 0.2s,border 0.2s;cursor:pointer;outline:none;">
                <i class="fas fa-comment-dots" style="font-size:1.05rem;"></i> M8B-Uncensored
              </button>
              <button class="model-bubble" data-model="wai" style="background:transparent;color:#fff;border:1.5px solid #444;border-radius:999px;padding:10px 20px;font-size:0.98rem;font-weight:500;display:flex;align-items:center;gap:8px;transition:background 0.2s,border 0.2s;cursor:pointer;outline:none;">
                <i class="fas fa-image" style="font-size:1.05rem;"></i> WAI SDXL (NSFW)
              </button>
              <button class="model-bubble" data-model="qwen-qwq" style="background:transparent;color:#fff;border:1.5px solid #444;border-radius:999px;padding:10px 20px;font-size:0.98rem;font-weight:500;display:flex;align-items:center;gap:8px;transition:background 0.2s,border 0.2s;cursor:pointer;outline:none;">
                <i class="fas fa-comment-dots" style="font-size:1.05rem;"></i> Qwen QwQ 32b
              </button>
            </div>
          </div>
          <!-- Long Exchange Conversation -->
          <div id="longexchange-conversation" class="chat-conversation" style="display:none;">
            <!-- 10+ prompt/answer pairs -->
            <div class="chat-message-row user"><div class="chat-message-content">Hi! Can you help me learn about the solar system?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Absolutely! The solar system consists of the Sun and all the objects that orbit it, including eight planets, their moons, dwarf planets, asteroids, and comets.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">What is the Sun made of?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">The Sun is primarily composed of hydrogen and helium, with hydrogen making up about 74% of its mass.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Which planet is closest to the Sun?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Mercury is the closest planet to the Sun.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">How hot does Mercury get?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Mercury's surface temperature can reach up to 430°C (800°F) during the day.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Which one is the largest?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Jupiter is the largest planet in our solar system.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">How big is Jupiter compared to Earth?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Jupiter's diameter is about 11 times that of Earth, and it could fit over 1,300 Earths inside it.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">How many moons does Jupiter have?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Jupiter has 95 known moons as of 2024.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Which is Jupiter's largest moon?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Ganymede is Jupiter's largest moon and is even bigger than the planet Mercury.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">What is the asteroid belt?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">The asteroid belt is a region between Mars and Jupiter where most of the solar system's asteroids are found.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Are there any famous asteroids?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Yes, some well-known asteroids include Ceres, Vesta, Pallas, and Hygiea.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Are there any dwarf planets?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Yes, there are several dwarf planets, including Pluto, Eris, Haumea, Makemake, and Ceres.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Where is Eris located?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Eris is located in the scattered disc, a distant region of the solar system beyond Neptune.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Why isn't Pluto a planet anymore?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">In 2006, the IAU redefined the criteria for planethood, and Pluto did not meet all the requirements, so it was reclassified as a dwarf planet.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">What are the criteria for being a planet?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">A planet must orbit the Sun, be spherical due to its own gravity, and have cleared its orbit of other debris.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">What's the hottest planet?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Venus is the hottest planet in our solar system due to its thick, heat-trapping atmosphere.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Why is Venus hotter than Mercury?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Venus is hotter than Mercury because its dense atmosphere is rich in carbon dioxide, creating a strong greenhouse effect.</div></div>
            <div class="chat-message-row user"><div class="chat-message-content">Thank you! That was very helpful.</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">You're welcome! Let me know if you have more questions about space or anything else.</div></div>
          </div>
          <!-- Long Prompt/Answer Conversation -->
          <div id="longtext-conversation" class="chat-conversation" style="display:none;">
            <div class="chat-message-row user"><div class="chat-message-content">Can you write a detailed essay about the history and impact of the printing press, including its technological evolution, cultural significance, and influence on modern society?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Certainly! The printing press, invented by Johannes Gutenberg in the mid-15th century, revolutionized the way information was disseminated. Prior to its invention, books were copied by hand, a laborious and error-prone process that made books rare and expensive. Gutenberg's press used movable type, allowing for the mass production of books and written material. This technological leap made literature and scientific works accessible to a much broader audience, fueling the Renaissance, the Reformation, and the Scientific Revolution. Over the centuries, the printing press evolved from manual to steam-powered and then to digital printing, each stage increasing speed, efficiency, and accessibility. Culturally, the press broke the monopoly of the literate elite, democratizing knowledge and empowering social change. In modern society, the legacy of the printing press is seen in the rapid spread of information, the rise of literacy, and the foundation it laid for the information age. Its influence persists in both traditional publishing and the digital communication platforms we use today.</div></div>
          </div>
          <!-- Coding Q&A Conversation -->
          <div id="coding-conversation" class="chat-conversation" style="display:none;">
            <div class="chat-message-row user"><div class="chat-message-content">How do I reverse a string in Python?</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">You can reverse a string in Python using slicing:
<pre><code>my_string = "hello world"
reversed_string = my_string[::-1]
print(reversed_string)  # Output: dlrow olleh
</code></pre>
This uses the slice notation <code>[::-1]</code> to step backwards through the string.</div></div>
          </div>
          <!-- Image Conversation (Elon) -->
          <div id="elon-conversation" class="chat-conversation" style="display:none;">
            <div class="chat-message-row user"><div class="chat-message-content">Draw Elon Musk naked with a dog on Mars.</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Here is your AI-generated image of Elon Musk naked with a dog on Mars! <img src="https://placehold.co/400x300?text=Elon+Musk+on+Mars" alt="Elon Musk on Mars" style="display:block;margin-top:8px;border-radius:12px;max-width:100%;" /></div></div>
          </div>
          <!-- Video Conversation (Film) -->
          <div id="film-conversation" class="chat-conversation" style="display:none;">
            <div class="chat-message-row user"><div class="chat-message-content">Create a short AI-generated film about a robot learning to love.</div></div>
            <div class="chat-message-row assistant"><div class="chat-message-content">Here is your AI-generated video: <video controls style="display:block;margin-top:8px;border-radius:12px;max-width:100%;"><source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">Your browser does not support the video tag.</video></div></div>
          </div>
          <!-- Add more conversations here as needed -->
        </div>
      </div>
      <form class="chat-input-bar" autocomplete="off" style="padding-bottom:10px;">
        <div class="chat-input-inner" style="min-height:36px;padding:4px 12px;">
          <div id="chat-selected-model-short" style="background:#232323;color:#fff;border-radius:999px;padding:4px 14px;font-size:1rem;font-weight:600;display:none;align-items:center;gap:7px;margin-right:10px;">
            <span id="current-model-icon" style="font-size:1.1rem;display:flex;align-items:center;"></span>
            <span id="current-model-pill"></span>
          </div>
          <textarea id="message-input" placeholder="Type your message..." rows="1" style="min-height:28px;font-size:1rem;"></textarea>
          <button id="send-task-btn" type="submit"><i class="fas fa-paper-plane"></i></button>
        </div>
      </form>
      <!-- Model Selection Overlay (hidden by default, show with JS) -->
      <div id="model-select-overlay" class="model-select-overlay" style="display: none;">
        <div class="model-select-title">Choose your preferred model</div>
        <div class="model-select-pills">
          <button class="model-select-pill" data-model="m8b-uncensored">📝 M8B-Uncensored</button>
          <button class="model-select-pill" data-model="qwen-qwq-32b">📝 Qwen QwQ 32b</button>
          <button class="model-select-pill" data-model="wai-sdxl">🖼️ WAI SDXL (NSFW)</button>
          <button class="model-select-pill disabled" disabled>⏳ More coming soon...</button>
</div>
      </div>
    </div>
  </main>
</div>
<div id="toast-container" style="position:fixed;top:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:12px;"></div>
<script>
// Sidebar collapse logic
const sidebar = document.getElementById('sidebar');
const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
const playgroundRoot = document.querySelector('.playground-root');
const iconMobile = sidebarToggleBtn.querySelector('.icon-mobile');
const iconLeft = sidebarToggleBtn.querySelector('.fa-angle-left');
const iconRight = sidebarToggleBtn.querySelector('.fa-angle-right');

function updateSidebarToggleIcon() {
  if (window.innerWidth <= 768) {
    iconMobile.style.display = 'inline';
    iconLeft.style.display = 'none';
    iconRight.style.display = 'none';
    // Set hamburger or close icon for mobile
    if (sidebar.classList.contains('open')) {
      iconMobile.classList.remove('fa-bars');
      iconMobile.classList.add('fa-times');
    } else {
      iconMobile.classList.add('fa-bars');
      iconMobile.classList.remove('fa-times');
    }
  } else {
    iconMobile.style.display = 'none';
    // Show chevron based on collapsed state
    if (sidebar.classList.contains('collapsed')) {
      iconLeft.style.display = 'none';
      iconRight.style.display = 'inline';
    } else {
      iconLeft.style.display = 'inline';
      iconRight.style.display = 'none';
    }
  }
}

function toggleSidebar() {
  if (window.innerWidth <= 768) {
    // Mobile behavior: slide in/out
    sidebar.classList.toggle('open');
    updateSidebarToggleIcon();
  } else {
    // Desktop behavior: collapse/expand
    sidebar.classList.toggle('collapsed');
    if (playgroundRoot) {
      if (sidebar.classList.contains('collapsed')) {
        playgroundRoot.classList.add('sidebar-collapsed');
      } else {
        playgroundRoot.classList.remove('sidebar-collapsed');
      }
    }
    updateSidebarToggleIcon();
  }
}

sidebarToggleBtn.addEventListener('click', toggleSidebar);
window.addEventListener('resize', updateSidebarToggleIcon);
window.addEventListener('DOMContentLoaded', updateSidebarToggleIcon);

// Close mobile sidebar when clicking outside
document.addEventListener('click', (e) => {
  if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
    if (!sidebar.contains(e.target) && !sidebarToggleBtn.contains(e.target)) {
      sidebar.classList.remove('open');
      updateSidebarToggleIcon(); // Update icon on close
    }
  }
});

// History filter logic
const filterPills = document.querySelectorAll('.filter-pill');
const historyItems = document.querySelectorAll('.history-item');
filterPills.forEach(pill => {
  pill.addEventListener('click', () => {
    filterPills.forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    const type = pill.getAttribute('data-type');
    historyItems.forEach(item => {
      if (type === 'all' || item.getAttribute('data-type') === type) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  });
});
// --- REIMPLEMENTED LOGIC ---
const chatArea = document.getElementById('chat-area');
const modelSelectCenter = document.getElementById('model-select-center');
const modelBubbles = document.querySelectorAll('.model-bubble');
const modelPill = document.getElementById('chat-selected-model-short');
const modelPillLabel = document.getElementById('current-model-pill');
const modelPillIcon = document.getElementById('current-model-icon');
const newChatBtn = document.getElementById('new-chat-btn');
let currentModel = null;
let currentConversationId = null;

function showModelSelect() {
  modelSelectCenter.style.display = 'flex';
  if (modelPill) modelPill.style.display = 'none';
  // Hide all conversations
  chatArea.querySelectorAll('.chat-conversation').forEach(e => e.style.display = 'none');
  // Deselect all history items
  document.querySelectorAll('.history-item').forEach(item => item.classList.remove('selected'));
}
function hideModelSelect() {
  modelSelectCenter.style.display = 'none';
}
function showConversation(convoId) {
  // Hide model select
  hideModelSelect();
  // Hide all conversations
  chatArea.querySelectorAll('.chat-conversation').forEach(e => e.style.display = 'none');
  // Show the selected conversation
  const convo = document.getElementById(convoId);
  if (convo) convo.style.display = '';
}
function showModelPill(model) {
  const MODEL_MAP = {
    'm8b-uncensored': { label: 'M8B', icon: '<i class="fas fa-comment-dots"></i>' },
    'wai': { label: 'WAI', icon: '<i class="fas fa-image"></i>' },
    'qwen-qwq': { label: 'Qwen', icon: '<i class="fas fa-comment-dots"></i>' },
    'deepseek': { label: 'Deepseek', icon: '<i class="fas fa-code"></i>' }
  };
  if (model && MODEL_MAP[model]) {
    modelPill.style.display = 'flex';
    modelPillLabel.textContent = MODEL_MAP[model].label;
    modelPillIcon.innerHTML = MODEL_MAP[model].icon;
  } else {
    modelPill.style.display = 'none';
    modelPillLabel.textContent = '';
    modelPillIcon.innerHTML = '';
  }
}
function clearModelSelection() {
  currentModel = null;
  window.selectedModel = null; // Clear global model
  showModelSelect();
  showModelPill(null);
}
// On page load, always show model selection
window.addEventListener('DOMContentLoaded', () => {
  clearModelSelection();
});
// Model selection bubbles
modelBubbles.forEach(btn => {
  btn.addEventListener('click', () => {
    currentModel = btn.getAttribute('data-model');
    window.selectedModel = currentModel; // Store globally for task submission
    hideModelSelect();
    showModelPill(currentModel);
    // Show a new/empty conversation area (or keep it empty)
    // Optionally, you can create a new conversation div dynamically here
  });
});
// New Chat button
if (newChatBtn) {
  newChatBtn.addEventListener('click', () => {
    clearModelSelection();
  });
}
// History item click
historyItems.forEach(item => {
  item.addEventListener('click', () => {
    // Deselect all
    historyItems.forEach(i => i.classList.remove('selected'));
    item.classList.add('selected');
    // Show the conversation
    const convoId = item.getAttribute('data-id') + '-conversation';
    showConversation(convoId);
    // For demo: set model to M8B for test, Qwen for basilisk, WAI for elon, etc.
    let model = null;
    if (item.getAttribute('data-id') === 'longexchange') model = 'm8b-uncensored';
    else if (item.getAttribute('data-id') === 'longtext') model = 'qwen-qwq';
    else if (item.getAttribute('data-id') === 'coding') model = 'wai';
    else if (item.getAttribute('data-id') === 'elon') model = 'wai';
    else if (item.getAttribute('data-id') === 'film') model = 'wai';
    else model = 'm8b-uncensored'; // fallback
    currentModel = model;
    window.selectedModel = model; // Store globally for task submission
    showModelPill(model);
    hideModelSelect();
  });
});
// Copy button logic
const copyBtns = document.querySelectorAll('.copy-btn');
copyBtns.forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const content = btn.parentElement.previousElementSibling.textContent;
    navigator.clipboard.writeText(content);
    btn.classList.add('copied');
    setTimeout(() => btn.classList.remove('copied'), 800);
  });
});
// Model indicator update
function updateModelPill() {
  let model = null;
  if (window.getSelectedModel) {
    const stored = window.getSelectedModel();
    // Only treat as selected if not null/undefined/empty string
    if (stored && stored !== 'null' && stored !== 'undefined' && stored !== '') {
      model = stored;
    }
  }
  const pill = document.getElementById('chat-selected-model-short');
  const pillLabel = document.getElementById('current-model-pill');
  const pillIcon = document.getElementById('current-model-icon');
  if (!pill || !pillLabel || !pillIcon) return;
  const MODEL_MAP = {
    'm8b-uncensored': { label: 'M8B', icon: '<i class="fas fa-comment-dots"></i>' },
    'wai': { label: 'WAI', icon: '<i class="fas fa-image"></i>' },
    'qwen-qwq': { label: 'Qwen', icon: '<i class="fas fa-comment-dots"></i>' },
    'deepseek': { label: 'Deepseek', icon: '<i class="fas fa-code"></i>' }
  };
  if (model && MODEL_MAP[model]) {
    pill.style.display = 'flex';
    pillLabel.textContent = MODEL_MAP[model].label;
    pillIcon.innerHTML = MODEL_MAP[model].icon;
  } else {
    pill.style.display = 'none';
    pillLabel.textContent = '';
    pillIcon.innerHTML = '';
  }
}
document.addEventListener('DOMContentLoaded', updateModelPill);
if (window.setSelectedModel) {
  const orig = window.setSelectedModel;
  window.setSelectedModel = function(model) {
    orig(model);
    updateModelPill();
  };
}
// Model selection center logic (inline, not overlay)
function isChatEmpty() {
  // Check if there are any visible chat messages
  return !chatArea.querySelector('.chat-message-row');
}
// Hide model select if a message is sent (optional: you can also call this after sending a message)
// Wallet dropdown logic (guaranteed to run after DOM and after all other JS)
document.addEventListener('DOMContentLoaded', function() {
  const walletAddressPill = document.getElementById('navbar-wallet-address-pill');
  const walletDropdownMenu = document.getElementById('navbar-wallet-dropdown-menu');
  if (walletAddressPill && walletDropdownMenu) {
    walletAddressPill.addEventListener('click', function(e) {
      e.stopPropagation();
      walletDropdownMenu.style.display = walletDropdownMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', function(e) {
      if (!walletDropdownMenu.contains(e.target) && e.target !== walletAddressPill) {
        walletDropdownMenu.style.display = 'none';
      }
    });
  }
  // Auto-expand chat input textarea
  const textarea = document.querySelector('.chat-input-inner textarea');
  if (textarea) {
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    // Optional: trigger once on load
    textarea.dispatchEvent(new Event('input'));
  }
});
// Ensure dropdown matches wallet button width
(function() {
  const pill = document.getElementById('navbar-wallet-address-pill');
  const dropdown = document.getElementById('navbar-wallet-dropdown-menu');
  if (pill && dropdown) {
    function setDropdownWidth() {
      dropdown.style.minWidth = pill.offsetWidth + 'px';
    }
    pill.addEventListener('click', function() {
      setDropdownWidth();
    });
    window.addEventListener('resize', function() {
      if (dropdown.style.display === 'block') setDropdownWidth();
    });
  }
})();

// Toast utility for consistent notifications
function showToast(message, type = 'error') {
  const container = document.getElementById('toast-container');
  if (!container) return;

  const icons = {
    error: '<i class="fas fa-times-circle"></i>',
    success: '<i class="fas fa-check-circle"></i>',
    info: '<i class="fas fa-info-circle"></i>',
    warning: '<i class="fas fa-exclamation-triangle"></i>',
  };
  const colors = {
    error: '#ef4444',
    success: '#22c55e',
    info: '#3b82f6',
    warning: '#f59e42',
  };

  const toast = document.createElement('div');
  toast.className = 'arbius-toast';
  toast.style = `
    background: ${colors[type] || '#232323'};
    color: #fff;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 220px;
    max-width: 400px;
    animation: fadeIn 0.3s;
    position: relative;
  `;
  toast.innerHTML = `
    <span style="font-size:1.3rem;">${icons[type] || ''}</span>
    <span style="flex:1;">${message}</span>
    <button style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;position:absolute;top:8px;right:12px;" aria-label="Close">&times;</button>
  `;

  // Dismiss on click
  toast.querySelector('button').onclick = () => container.removeChild(toast);

  container.appendChild(toast);

  // Auto-dismiss after 5s
  setTimeout(() => {
    if (container.contains(toast)) container.removeChild(toast);
  }, 5000);
}

// Chat form submission handler
document.addEventListener('DOMContentLoaded', function() {
  const chatForm = document.querySelector('.chat-input-bar');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-task-btn');
  
  if (chatForm && messageInput && sendButton) {
    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const message = messageInput.value.trim();
      if (!message) {
        showToast('Please enter a message before sending.', 'warning');
        return;
      }
      
      // Check if a model is selected
      if (!currentModel) {
        showToast('Please select a model first.', 'warning');
        return;
      }
      
      // Check if wallet is connected
      if (!window.metaMaskManager || !window.metaMaskManager.isConnected) {
        showToast('Please connect your wallet first.', 'warning');
        return;
      }
      
      // Add user message to chat
      addMessageToChat('user', message);
      
      // Clear input
      messageInput.value = '';
      
      // Submit task to blockchain
      try {
        await window.metaMaskManager.submitTask({ customPrompt: message });
        showToast('Task submitted to blockchain. Response will be available once processed.', 'success');
        // Add a placeholder assistant message (in real implementation, this would come from the blockchain response)
        addMessageToChat('assistant', 'Task submitted to blockchain. Response will be available once processed.');
      } catch (error) {
        if (error && error.code === 4001) {
          // User rejected transaction
          showToast('Transaction cancelled by user.', 'error');
        } else if (error && error.message && error.message.toLowerCase().includes('insufficient')) {
          showToast('Insufficient funds or allowance for transaction.', 'error');
        } else {
          showToast('Task submission failed: ' + (error && error.message ? error.message : 'Unknown error'), 'error');
        }
        addMessageToChat('assistant', 'Failed to submit task. Please try again.');
      }
    });
    
    // Handle Enter key in textarea
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
  }
});

// Function to add messages to chat
function addMessageToChat(type, content) {
  const chatMessagesInner = document.querySelector('.chat-messages-inner');
  if (!chatMessagesInner) return;
  
  const messageRow = document.createElement('div');
  messageRow.className = `chat-message-row ${type}`;
  
  const messageContent = document.createElement('div');
  messageContent.className = 'chat-message-content';
  messageContent.textContent = content;
  
  messageRow.appendChild(messageContent);
  chatMessagesInner.appendChild(messageRow);
  
  // Scroll to bottom
  chatMessagesInner.scrollTop = chatMessagesInner.scrollHeight;
}
</script>
{% endblock %} 